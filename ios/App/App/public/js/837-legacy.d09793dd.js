"use strict";(self["webpackChunkpapillon"]=self["webpackChunkpapillon"]||[]).push([[837],{8527:(e,t,n)=>{n.d(t,{Vb:()=>s,LE:()=>o});var o,a=n(9895);(function(e){e["Default"]="DEFAULT",e["Destructive"]="DESTRUCTIVE",e["Cancel"]="CANCEL"})(o||(o={}));const s=(0,a.fo)("ActionSheet",{web:()=>n.e(185).then(n.bind(n,8185)).then((e=>new e.ActionSheetWeb))})},3827:(e,t,n)=>{n.d(t,{Z:()=>c});n(8862);var o=n(6154),a=n(4490),s=n(2560);function r(e){switch(localStorage.loginService){case"pronote":return i(e);case"ecoledirecte":return}}async function i(e){const t=a.l.config.globalProperties.$api,n=localStorage.getItem("token"),r=`${t}/discussions?token=${n}`;let i=localStorage.getItem("ConversationsCache");if(null!=i&&!e){i=JSON.parse(i);const e=new Date,t=new Date(i.date);if(e.toDateString()==t.toDateString())return new Promise((e=>{e(l(i.conversations))}))}let c={};return o.Z.get(r).then((e=>{c=e.data;const t=new Date,n={date:t,conversations:e.data};return localStorage.setItem("ConversationsCache",JSON.stringify(n)),c=l(c),c})).catch((e=>{if(e.response&&("notfound"==e.response.data||"expired"==e.response.data)&&(0,s["default"])(),e.code)return new Promise((t=>{t({error:e.code})}))}))}function l(e){return e}const c=r},575:(e,t,n)=>{n.r(t),n.d(t,{default:()=>O});n(4916),n(5306);var o=n(6252),a=n(9963),s=n(3577);const r=e=>((0,o.dD)("data-v-39aa9186"),e=e(),(0,o.Cn)(),e),i=r((()=>(0,o._)("span",{class:"material-symbols-outlined mdls",slot:"icon-only"},"add",-1))),l={key:0,class:"NoCours"},c=r((()=>(0,o._)("span",{class:"material-symbols-outlined mdls"},"forum",-1))),u=r((()=>(0,o._)("h2",null,"Aucune conversation n'a été trouvée.",-1))),d=r((()=>(0,o._)("p",null,"Essayez d'envoyer un message à quelqu'un dans votre établissement.",-1))),p=[c,u,d],h={key:1,class:"NoCours"},w=r((()=>(0,o._)("br",null,null,-1))),m=r((()=>(0,o._)("h2",null,"Téléchargement des conversations...",-1))),f=r((()=>(0,o._)("p",null,"Veuillez patienter pendant qu'on récupère les conversations depuis nos serveurs...",-1))),g=r((()=>(0,o._)("span",{class:"material-symbols-outlined mdls",slot:"start"},"forum",-1))),v=r((()=>(0,o._)("br",null,null,-1))),b=r((()=>(0,o._)("br",null,null,-1))),_=r((()=>(0,o._)("br",null,null,-1))),I=r((()=>(0,o._)("br",null,null,-1))),C=r((()=>(0,o._)("br",null,null,-1))),k={key:0,class:"material-symbols-outlined mdls",slot:"start"},y={key:1,class:"material-symbols-outlined mdls",slot:"start"};function W(e,t,n,r,c,u){const d=(0,o.up)("ion-menu-button"),W=(0,o.up)("ion-buttons"),T=(0,o.up)("ion-title"),D=(0,o.up)("IonToolbar"),x=(0,o.up)("IonHeader"),R=(0,o.up)("ion-toolbar"),S=(0,o.up)("ion-header"),L=(0,o.up)("ion-refresher-content"),M=(0,o.up)("ion-refresher"),P=(0,o.up)("ion-button"),U=(0,o.up)("IonFab"),$=(0,o.up)("IonSpinner"),j=(0,o.up)("ion-label"),A=(0,o.up)("IonItem"),E=(0,o.up)("IonNavLink"),H=(0,o.up)("IonList"),N=(0,o.up)("IonButton"),O=(0,o.up)("IonButtons"),z=(0,o.up)("IonTitle"),Z=(0,o.up)("IonInput"),B=(0,o.up)("IonTextarea"),F=(0,o.up)("ion-checkbox"),K=(0,o.up)("ion-radio-group"),J=(0,o.up)("ion-content"),V=(0,o.up)("IonModal"),q=(0,o.up)("ion-page");return(0,o.wg)(),(0,o.j4)(q,{ref:"page"},{default:(0,o.w5)((()=>[(0,o.Wm)(x,{class:"AppHeader",translucent:""},{default:(0,o.w5)((()=>[(0,o.Wm)(D,null,{default:(0,o.w5)((()=>[(0,o.Wm)(W,{slot:"start"},{default:(0,o.w5)((()=>[(0,o.Wm)(d,{color:"dark"})])),_:1}),(0,o.Wm)(T,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Conversations")])),_:1})])),_:1})])),_:1}),(0,o.Wm)(J,{fullscreen:!0},{default:(0,o.w5)((()=>[(0,o.Wm)(S,{collapse:"condense"},{default:(0,o.w5)((()=>[(0,o.Wm)(R,null,{default:(0,o.w5)((()=>[(0,o.Wm)(T,{size:"large"},{default:(0,o.w5)((()=>[(0,o.Uk)("Conversations")])),_:1})])),_:1})])),_:1}),(0,o.Wm)(M,{slot:"fixed",onIonRefresh:t[0]||(t[0]=t=>e.handleRefresh(t))},{default:(0,o.w5)((()=>[(0,o.Wm)(L)])),_:1}),(0,o.Wm)(U,{slot:"fixed",vertical:"bottom",horizontal:"end",class:"newCoursBtnFab"},{default:(0,o.w5)((()=>[(0,o.Wm)(P,{onClick:t[1]||(t[1]=t=>e.startNewChat()),size:"large",shape:"round",class:"newCoursBtn",mode:"md"},{default:(0,o.w5)((()=>[i])),_:1})])),_:1}),(0,o.Wm)(a.uT,{name:"NoCoursAnim"},{default:(0,o.w5)((()=>[0!=this.conversations.length||e.isLoading?0==this.conversations.length&&e.isLoading?((0,o.wg)(),(0,o.iD)("div",h,[(0,o.Wm)($),w,m,f])):(0,o.kq)("",!0):((0,o.wg)(),(0,o.iD)("div",l,p))])),_:1}),(0,o.Wm)(H,null,{default:(0,o.w5)((()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(e.conversations,((t,n)=>((0,o.wg)(),(0,o.j4)(E,{key:n,"router-direction":"forward",component:e.ConversationView,componentProps:{conversation:t}},{default:(0,o.w5)((()=>[(0,o.Wm)(A,{button:""},{default:(0,o.w5)((()=>[g,(0,o.Wm)(j,null,{default:(0,o.w5)((()=>[(0,o._)("h2",null,(0,s.zw)(t.subject),1),(0,o._)("p",null,(0,s.zw)(t.messages[t.messages.length-1].content.replace("<br/>"," ")),1),(0,o._)("small",null,(0,s.zw)(t.creator),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["component","componentProps"])))),128))])),_:1}),v,b,_,I,C,(0,o.Wm)(V,{"presenting-element":e.presentingElement,class:"newChatModal","is-open":e.newConvModalOpen},{default:(0,o.w5)((()=>[(0,o.Wm)(x,{translucent:""},{default:(0,o.w5)((()=>[(0,o.Wm)(D,null,{default:(0,o.w5)((()=>[(0,o.Wm)(O,{slot:"start"},{default:(0,o.w5)((()=>[(0,o.Wm)(N,{onClick:t[2]||(t[2]=t=>e.setnewConvModalOpen(!1))},{default:(0,o.w5)((()=>[(0,o.Uk)("Annuler")])),_:1})])),_:1}),(0,o.Wm)(z,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Nouvelle conversation")])),_:1}),(0,o.Wm)(O,{slot:"end"},{default:(0,o.w5)((()=>[(0,o.Wm)(N,{color:"primary",onClick:t[3]||(t[3]=t=>e.startConversation())},{default:(0,o.w5)((()=>[(0,o.Uk)("Créer")])),_:1})])),_:1})])),_:1})])),_:1}),(0,o.Wm)(J,null,{default:(0,o.w5)((()=>[(0,o.Wm)(H,{inset:""},{default:(0,o.w5)((()=>[(0,o.Wm)(A,null,{default:(0,o.w5)((()=>[(0,o.Wm)(Z,{ref:"newChatSubject",placeholder:"Sujet"},null,512)])),_:1}),(0,o.Wm)(A,null,{default:(0,o.w5)((()=>[(0,o.Wm)(B,{class:"newChatMsg",ref:"newChatMsg",placeholder:"Contenu du 1er message"},null,512)])),_:1})])),_:1}),(0,o.Wm)(H,{style:{"padding-bottom":"100px"}},{default:(0,o.w5)((()=>[(0,o.Wm)(K,null,{default:(0,o.w5)((()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(e.recipients,((t,n)=>((0,o.wg)(),(0,o.j4)(A,{key:n},{default:(0,o.w5)((()=>["teacher"==t.type?((0,o.wg)(),(0,o.iD)("span",k,"face")):((0,o.wg)(),(0,o.iD)("span",y,"person")),(0,o.Wm)(j,null,{default:(0,o.w5)((()=>[(0,o._)("h2",null,(0,s.zw)(t.name),1),(0,o._)("p",null,(0,s.zw)(t.functions.join(", ")),1)])),_:2},1024),(0,o.Wm)(F,{slot:"end",onClick:n=>e.selectRecipient(t.id)},null,8,["onClick"])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})])),_:1},8,["presenting-element","is-open"])])),_:1})])),_:1},512)}n(6699),n(7658),n(3948),n(1637),n(2062),n(8862);var T=n(5274),D=n(3162),x=n(3827),R=n(6154),S=n(4490),L=n(2560);function M(e){switch(localStorage.loginService){case"pronote":return P(e);case"ecoledirecte":return}}async function P(e){const t=S.l.config.globalProperties.$api,n=localStorage.getItem("token"),o=`${t}/recipients?token=${n}`;let a=localStorage.getItem("RecipientsCache");if(null!=a&&!e){a=JSON.parse(a);const e=new Date,t=new Date(a.date);if(e.toDateString()==t.toDateString())return new Promise((e=>{e(U(a.Recipients))}))}let s={};return R.Z.get(o).then((e=>{s=e.data;const t=new Date,n={date:t,Recipients:e.data};return localStorage.setItem("RecipientsCache",JSON.stringify(n)),s=U(s),s})).catch((e=>{if(e.response&&("notfound"==e.response.data||"expired"==e.response.data)&&(0,L["default"])(),e.code)return new Promise((t=>{t({error:e.code})}))}))}function U(e){return e}const $=M;var j=n(8042),A=n(8903);const E=(0,o.aZ)({name:"FolderPage",components:{IonHeader:T.Gu,IonToolbar:T.sr,IonList:T.q_,IonItem:T.Ie,IonNavLink:T.Qx,IonFab:T.IJ,IonButton:T.YG,IonButtons:T.Sm,IonTitle:T.wd,IonModal:T.ki,IonCheckbox:T.nz,IonRadioGroup:T.se,IonInput:T.pK,IonTextarea:T.g2,IonRefresher:T.nJ,IonRefresherContent:T.Wo,IonPage:T._i,IonSpinner:T.PQ},setup(){return{}},methods:{handleRefresh(e){(0,x.Z)(!0).then((e=>{this.conversations=e})),e&&this.$watch("conversations",(()=>{setTimeout((()=>{e.target.complete()}),200)}))},refreshRecipients(){$(!0).then((e=>{this.recipients=e}))},setnewConvModalOpen(e){this.newConvModalOpen=e},startNewChat(){this.checkedRecipients=[],this.refreshRecipients(),this.newConvModalOpen=!0},selectRecipient(e){this.checkedRecipients.includes(e)?this.checkedRecipients.splice(this.checkedRecipients.indexOf(e),1):this.checkedRecipients.push(e)},startConversation(){const e=this.$refs.newChatSubject.$el.value,t=this.$refs.newChatMsg.$el.value,n=this.checkedRecipients,o=this.$api,a=localStorage.getItem("token"),s=new Headers;s.append("Content-Type","application/x-www-form-urlencoded");const r=new URLSearchParams;r.append("token",a),r.append("content",t),r.append("recipientsId",JSON.stringify(n)),r.append("subject",e);const i={method:"POST",headers:s,body:r,redirect:"follow"};fetch(o+"/discussion/create",i).then((e=>e.json())).then((e=>{if("ok"!=e.status)return void 0!=e.error?void D.Z.presentToastFull("Impossible de créer la conversation","Une erreur est survenue lors de la création de la conversation.","danger",A.no6,!0,e.error):void 0!=e.errors?void D.Z.presentToastFull("Impossible de créer la conversation","Veuillez remplir tous les champs pour créer la conversation.","danger",A.no6):void D.Z.presentToastFull("Impossible de créer la conversation","Une erreur est survenue lors de la création de la conversation.","danger",A.no6,!0,e);D.Z.presentToastFull("Conversation créée","La conversation a bien été créée.","success",A.d29),this.newConvModalOpen=!1,this.handleRefresh()}))}},data(){return{conversations:[],recipients:[],ConversationView:j["default"],newConvModalOpen:!1,checkedRecipient:[],isLoading:!1,presentingElement:null}},mounted(){this.presentingElement=this.$refs.page.$el,this.isLoading=!0,(0,x.Z)().then((e=>{this.conversations=e,this.isLoading=!1})),$().then((e=>{this.recipients=e})),document.addEventListener("tokenUpdated",(()=>{(0,x.Z)().then((e=>{this.conversations=e})),$().then((e=>{this.recipients=e}))}))}});var H=n(3744);const N=(0,H.Z)(E,[["render",W],["__scopeId","data-v-39aa9186"]]),O=N},8042:(e,t,n)=>{n.r(t),n.d(t,{default:()=>C});n(3948);var o=n(6252),a=n(3577);const s={class:"chatUI"},r={class:"author"},i=["innerHTML"],l={class:"author"},c=["innerHTML"],u={class:"chatbox"};function d(e,t,n,d,p,h){const w=(0,o.up)("IonBackButton"),m=(0,o.up)("ion-buttons"),f=(0,o.up)("ion-skeleton-text"),g=(0,o.up)("ion-title"),v=(0,o.up)("IonToolbar"),b=(0,o.up)("IonHeader"),_=(0,o.up)("ion-refresher-content"),I=(0,o.up)("ion-refresher"),C=(0,o.up)("ion-content");return(0,o.wg)(),(0,o.iD)(o.HY,null,[(0,o.Wm)(b,{class:"AppHeader",translucent:""},{default:(0,o.w5)((()=>[(0,o.Wm)(v,null,{default:(0,o.w5)((()=>[(0,o.Wm)(m,{slot:"start"},{default:(0,o.w5)((()=>[(0,o.Wm)(w,{class:"only-ios",text:"Retour",onClick:e.pop},null,8,["onClick"]),(0,o.Wm)(w,{class:"only-md",onClick:e.pop},null,8,["onClick"])])),_:1}),e.conversation.subject?((0,o.wg)(),(0,o.j4)(g,{key:1},{default:(0,o.w5)((()=>[(0,o.Uk)((0,a.zw)(e.conversation.subject),1)])),_:1})):((0,o.wg)(),(0,o.j4)(g,{key:0},{default:(0,o.w5)((()=>[(0,o.Wm)(f,{animated:!0,style:{width:"80%"}})])),_:1}))])),_:1})])),_:1}),(0,o.Wm)(C,{class:"content showScroll",fullscreen:!0},{default:(0,o.w5)((()=>[(0,o.Wm)(I,{slot:"fixed",onIonRefresh:t[0]||(t[0]=t=>e.handleRefresh(t))},{default:(0,o.w5)((()=>[(0,o.Wm)(_)])),_:1}),(0,o._)("div",s,[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(e.messages,((n,s)=>((0,o.wg)(),(0,o.iD)("div",{key:s},["Moi"!==n.author?((0,o.wg)(),(0,o.iD)("div",{key:0,onClick:t[1]||(t[1]=t=>e.openMessage(t)),class:"message theirs"},[(0,o._)("p",r,(0,a.zw)(n.author),1),(0,o._)("div",{class:"bubble",innerHTML:n.content},null,8,i)])):((0,o.wg)(),(0,o.iD)("div",{key:1,onClick:t[2]||(t[2]=t=>e.openMessage(t)),class:"message me"},[(0,o._)("p",l,(0,a.zw)(n.author),1),(0,o._)("div",{class:"bubble",innerHTML:n.content},null,8,c)]))])))),128))]),(0,o._)("div",u,[(0,o._)("input",{onKeydown:t[3]||(t[3]=(...t)=>e.inputKeyPress&&e.inputKeyPress(...t)),type:"text",class:"chatbox_input",placeholder:"Non disponible pour le moment",disabled:""},null,32)])])),_:1})],64)}n(4916),n(5306),n(2707),n(1637),n(2062);var p=n(5274),h=n(8527),w=n(9895);class m extends w.Uw{async write(e){if("undefined"===typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if(void 0!==e.string)await this.writeText(e.string);else if(e.url)await this.writeText(e.url);else{if(!e.image)throw new Error("Nothing to write");if("undefined"===typeof ClipboardItem)throw this.unavailable("Writing images to the clipboard is not supported in this browser");try{const t=await(await fetch(e.image)).blob(),n=new ClipboardItem({[t.type]:t});await navigator.clipboard.write([n])}catch(t){throw new Error("Failed to write image")}}}async read(){if("undefined"===typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if("undefined"===typeof ClipboardItem)return this.readText();try{const e=await navigator.clipboard.read(),t=e[0].types[0],n=await e[0].getType(t),o=await this._getBlobData(n,t);return{value:o,type:t}}catch(e){return this.readText()}}async readText(){if("undefined"===typeof navigator||!navigator.clipboard||!navigator.clipboard.readText)throw this.unavailable("Reading from clipboard not supported in this browser");const e=await navigator.clipboard.readText();return{value:e,type:"text/plain"}}async writeText(e){if("undefined"===typeof navigator||!navigator.clipboard||!navigator.clipboard.writeText)throw this.unavailable("Writting to clipboard not supported in this browser");await navigator.clipboard.writeText(e)}_getBlobData(e,t){return new Promise(((n,o)=>{const a=new FileReader;t.includes("image")?a.readAsDataURL(e):a.readAsText(e),a.onloadend=()=>{const e=a.result;n(e)},a.onerror=e=>{o(e)}}))}}const f=(0,w.fo)("Clipboard",{web:()=>new m});var g=n(3827),v=n(575);const b=(0,o.aZ)({name:"FolderPage",components:{IonHeader:p.Gu,IonToolbar:p.sr,IonRefresher:p.nJ,IonRefresherContent:p.Wo,IonSkeletonText:p.CK,IonBackButton:p.oU},props:{conversation:{type:Object,required:!0}},data(){return{messages:[],refreshInterval:null,conversationID:this.conversation.id,ChatView:v["default"]}},methods:{async openMessage(){let e=event.target.innerText;if(e.match(/^(https?:\/\/[^\s]+)/g))return!1;e=e.replace(/\s\s+/g," ");let t=e.substring(0,150);e.length>150&&(t+="..."),t=t.replace(/\n/g," ");const n=await h.Vb.showActions({title:"Actions du message",message:t,options:[{title:"Copier le texte"},{title:"Annuler",style:h.LE.Cancel}]});0===n.index&&f.write({string:e})},handleRefresh(e){(0,g.Z)(!0).then((t=>{e&&e.detail.complete();const n=t.filter((e=>e.id===this.conversationID));this.messages=n[0].messages,this.messages.sort(((e,t)=>new Date(e.date)-new Date(t.date)))}))},inputKeyPress(e){"Enter"===e.key&&(this.sendMessage(e.target.value),e.target.value="")},sendMessage(e){const t=this.$api,n=localStorage.getItem("token"),o=new Headers;o.append("Content-Type","application/x-www-form-urlencoded");const a=new URLSearchParams;a.append("token",n),a.append("content",e),a.append("discussionId",this.conversationID);const s={method:"POST",headers:o,body:a,redirect:"follow"};fetch(t+"/discussion/reply",s).then((e=>e.json())).then((e=>{if("ok"!==e)return!1;this.handleRefresh()}))}},mounted(){this.conversationID=this.conversation.id,this.messages=this.conversation.messages,this.messages.sort(((e,t)=>new Date(e.date)-new Date(t.date))),this.messages.forEach((e=>{const t=/(https?:\/\/[^\s]+)/g;e.content.match(/<a/g)?e.content=e.content.replace(/<a/g,'<a target="_blank"'):e.content=e.content.replace(t,'<a target="_blank" @click.stop class="inherit" href="$1">$1</a>'),e.content=e.content.replace(/\n/g,"<br/>")})),document.addEventListener("tokenUpdated",(()=>{this.handleRefresh()}))}});var _=n(3744);const I=(0,_.Z)(b,[["render",d],["__scopeId","data-v-5bb317f2"]]),C=I}}]);
//# sourceMappingURL=837-legacy.d09793dd.js.map